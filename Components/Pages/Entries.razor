@page "/entries"
@inject JournalDatabase journalDb
@inject NavigationManager Nav
@inject PinService pinService
@using MauiApp1.Services

@if (!isPinVerified)
{
    <div class="pin-dialog-overlay">
        <div class="pin-dialog">
            <h4><i class="fas fa-lock"></i> @(pinService.IsPinSet() ? "Enter PIN" : "Create PIN")</h4>
            
            @if (!string.IsNullOrEmpty(pinError))
            {
                <div class="alert alert-danger">@pinError</div>
            }
            
            @if (!pinService.IsPinSet())
            {
                <div class="form-group">
                    <label>Create PIN (minimum 4 digits):</label>
                    <input type="password" @bind="pinInput" @bind:event="oninput" class="form-control" placeholder="Enter PIN" maxlength="10" />
                </div>
                <div class="form-group">
                    <label>Confirm PIN:</label>
                    <input type="password" @bind="pinConfirm" @bind:event="oninput" class="form-control" placeholder="Confirm PIN" maxlength="10" />
                </div>
                <div class="button-group">
                    <button @onclick="CreatePin" class="btn btn-primary">
                        <i class="fas fa-check"></i> Create PIN
                    </button>
                </div>
            }
            else
            {
                <div class="form-group">
                    <label>Enter PIN:</label>
                    <input type="password" @bind="pinInput" @bind:event="oninput" @onkeypress="OnPinKeyPress" class="form-control" placeholder="Enter PIN" maxlength="10" autofocus />
                </div>
                <div class="button-group">
                    <button @onclick="VerifyPin" class="btn btn-primary">
                        <i class="fas fa-unlock"></i> Enter
                    </button>
                    <button @onclick="ForgetPin" class="btn btn-outline-danger">
                        <i class="fas fa-key"></i> Forget PIN
                    </button>
                </div>
            }
        </div>
    </div>
}

@if (isPinVerified)
{
<h4><i class="fas fa-list"></i> All Entries</h4>

<div class="search-filter-group">
    <div class="form-group">
        <input type="text" @bind="searchTerm" @oninput="HandleSearch" class="form-control" placeholder="Search entries by content..." />
    </div>

    <div class="filter-row">
    <div class="form-group">
        <label>Filter by Mood:</label>
        <select @bind="filterMood" @bind:event="onchange" @bind:after="OnFilterChanged" class="form-control">
            <option value="">-- All Moods --</option>
            @foreach (var mood in allMoods)
            {
                <option value="@mood">@mood</option>
            }
        </select>
        </div>

        <div class="form-group">
            <label>Filter by Tag:</label>
            <select @bind="filterTag" @bind:event="onchange" @bind:after="OnFilterChanged" class="form-control">
                <option value="">-- All Tags --</option>
                @foreach (var tag in availableTags)
                {
                    <option value="@tag">@tag</option>
                }
            </select>
        </div>
    </div>

    <div class="date-range-filter">
        <div class="form-group">
            <label>Date Range:</label>
            <div class="date-inputs">
                <div>
                    <label class="date-label">From:</label>
                    <input type="date" @bind="startDate" @bind:event="onchange" class="form-control" />
                </div>
                <div>
                    <label class="date-label">To:</label>
                    <input type="date" @bind="endDate" @bind:event="onchange" class="form-control" />
                </div>
                <button @onclick="ClearDateFilter" class="btn btn-sm btn-outline-secondary" title="Clear date filter">
                    <i class="fas fa-times"></i>
                </button>
            </div>
        </div>
    </div>

    <button @onclick="LoadEntries" class="btn btn-outline-primary full-width">
        <i class="fas fa-sync-alt"></i> Refresh
    </button>
</div>

@if (paginatedEntries == null || paginatedEntries.Count == 0)
{
    <div class="empty-state">
        <i class="fas fa-inbox"></i>
        <p>No entries found.</p>
    </div>
}
else
{
    <div class="entries-list">
        <div class="entries-header">
            <p class="entries-count">Showing @GetDisplayRange() of @totalFilteredCount entry(ies)</p>
            <div class="page-size-selector">
                <label>Entries per page:</label>
                <select @bind="pageSize" @bind:event="onchange" @bind:after="OnPageSizeChanged" class="form-control page-size-select">
                    <option value="5">5</option>
                    <option value="10">10</option>
                    <option value="20">20</option>
                    <option value="50">50</option>
                </select>
            </div>
        </div>
        @foreach (var entry in paginatedEntries)
        {
            <div class="entry-card">
                <div class="entry-header">
                    <div class="entry-date">
                        <i class="fas fa-calendar"></i> @entry.EntryDate.ToString("ddd, MMM dd, yyyy")
                    </div>
                    <div class="entry-moods">
                        <span class="mood-badge @GetMoodClass(entry.PrimaryMood)">
                            <i class="fas @GetMoodIcon(entry.PrimaryMood)"></i> @entry.PrimaryMood
                        </span>
                        @if (!string.IsNullOrEmpty(entry.SecondaryMood1))
                        {
                            <span class="mood-badge secondary @GetMoodClass(entry.SecondaryMood1)">
                                <i class="fas @GetMoodIcon(entry.SecondaryMood1)"></i> @entry.SecondaryMood1
                            </span>
                        }
                        @if (!string.IsNullOrEmpty(entry.SecondaryMood2))
                        {
                            <span class="mood-badge secondary @GetMoodClass(entry.SecondaryMood2)">
                                <i class="fas @GetMoodIcon(entry.SecondaryMood2)"></i> @entry.SecondaryMood2
                            </span>
                        }
                    </div>
                </div>

                @if (!string.IsNullOrEmpty(entry.Category))
                {
                    <div class="entry-category">
                        <i class="fas fa-tag"></i> @entry.Category
                    </div>
                }

                <div class="entry-content">
                    @((MarkupString)MarkdownRenderer.RenderPreview(entry.Content, 300))
                </div>

                @if (!string.IsNullOrEmpty(entry.Tags))
                {
                    <div class="entry-tags">
                        @foreach (var tag in entry.Tags.Split(',', System.StringSplitOptions.RemoveEmptyEntries))
                        {
                            <span class="tag">@tag.Trim()</span>
                        }
                    </div>
                }

                <div class="entry-footer">
                    <small>Created: @entry.CreatedAt.ToString("MMM dd, yyyy HH:mm")</small>
                        @if (entry.CreatedAt != entry.UpdatedAt)
                    {
                        <small class="entry-updated">Updated: @entry.UpdatedAt.ToString("MMM dd, yyyy HH:mm")</small>
                    }
                </div>

                <div class="entry-actions">
                    <button @onclick="() => EditEntry(entry.Id)" class="btn btn-sm btn-warning">
                        <i class="fas fa-edit"></i> Edit
                    </button>
                    <button @onclick="() => DeleteEntry(entry.Id)" class="btn btn-sm btn-danger">
                        <i class="fas fa-trash"></i> Delete
                    </button>
                </div>
            </div>
        }
    </div>

    @if (totalPages > 1)
    {
        <div class="pagination-container">
            <div class="pagination-info">
                Page @currentPage of @totalPages
            </div>
            <div class="pagination-controls">
                <button @onclick="GoToFirstPage" class="btn btn-sm btn-outline-primary" disabled="@(currentPage == 1)" title="First page">
                    <i class="fas fa-angle-double-left"></i>
                </button>
                <button @onclick="GoToPreviousPage" class="btn btn-sm btn-outline-primary" disabled="@(currentPage == 1)" title="Previous page">
                    <i class="fas fa-chevron-left"></i> Previous
                </button>
                
                @for (int i = GetStartPage(); i <= GetEndPage(); i++)
                {
                    var pageNum = i;
                    <button @onclick="() => GoToPage(pageNum)" 
                            class="btn btn-sm @(pageNum == currentPage ? "btn-primary" : "btn-outline-primary")"
                            title="Page @pageNum">
                        @pageNum
                    </button>
                }
                
                <button @onclick="GoToNextPage" class="btn btn-sm btn-outline-primary" disabled="@(currentPage == totalPages)" title="Next page">
                    Next <i class="fas fa-chevron-right"></i>
                </button>
                <button @onclick="GoToLastPage" class="btn btn-sm btn-outline-primary" disabled="@(currentPage == totalPages)" title="Last page">
                    <i class="fas fa-angle-double-right"></i>
                </button>
            </div>
        </div>
    }
}
}

@code {
    private bool isPinVerified = false;
    private string pinInput = "";
    private string pinConfirm = "";
    private string pinError = "";

    private List<string> allMoods = new();
    private List<string> availableTags = new();
    private List<JournalEntry> allEntries = new();
    private List<JournalEntry> filteredEntries = new();
    private List<JournalEntry> paginatedEntries = new();
    private string searchTerm = "";
    private string filterMood = "";
    private string filterTag = "";
    private DateTime? startDate = null;
    private DateTime? endDate = null;
    
    private int currentPage = 1;
    private int pageSize = 10;
    private int totalPages = 1;
    private int totalFilteredCount = 0;

    protected override async Task OnInitializedAsync()
    {
        allMoods.AddRange(MoodCategories.PositiveMoods);
        allMoods.AddRange(MoodCategories.NeutralMoods);
        allMoods.AddRange(MoodCategories.NegativeMoods);
        allMoods.Sort();

        // Check if PIN is already verified (session)
        if (pinService.IsPinSet())
        {
            // PIN is set, need to verify
            isPinVerified = false;
        }
        else
        {
            // No PIN set yet, will show create PIN dialog
            isPinVerified = false;
        }
    }

    private void OnPinKeyPress(KeyboardEventArgs e)
    {
        if (e.Key == "Enter")
        {
            VerifyPin();
        }
    }

    private void CreatePin()
    {
        pinError = "";
        
        if (string.IsNullOrWhiteSpace(pinInput))
        {
            pinError = "PIN cannot be empty.";
            return;
        }

        if (pinInput.Length < 4)
        {
            pinError = "PIN must be at least 4 characters long.";
            return;
        }

        if (pinInput != pinConfirm)
        {
            pinError = "PINs do not match. Please try again.";
            return;
        }

        if (pinService.CreatePin(pinInput, pinConfirm))
        {
            isPinVerified = true;
            pinInput = "";
            pinConfirm = "";
            pinError = "";
            LoadEntries();
        }
        else
        {
            pinError = "Failed to create PIN. Please try again.";
        }
    }

    private void VerifyPin()
    {
        pinError = "";
        
        if (string.IsNullOrWhiteSpace(pinInput))
        {
            pinError = "Please enter your PIN.";
            return;
        }

        if (pinService.VerifyPin(pinInput))
        {
            isPinVerified = true;
            pinInput = "";
            pinError = "";
            LoadEntries();
        }
        else
        {
            pinError = "Incorrect PIN. Please try again.";
            pinInput = "";
        }
    }

    private void ForgetPin()
    {
        pinService.ResetPin();
        isPinVerified = false;
        pinInput = "";
        pinConfirm = "";
        pinError = "";
        StateHasChanged();
    }

    private async Task LoadEntries()
    {
        allEntries = await journalDb.GetAllEntriesAsync();
        
        availableTags = allEntries
            .SelectMany(e => (e.Tags ?? "").Split(',', StringSplitOptions.RemoveEmptyEntries))
            .Select(t => t.Trim().TrimStart('#'))
            .Where(t => !string.IsNullOrWhiteSpace(t))
            .Distinct()
            .OrderBy(t => t)
            .ToList();
        
        ApplyFilters();
    }

    private void ApplyFilters()
    {
        filteredEntries = allEntries;
        
        if (startDate.HasValue || endDate.HasValue)
        {
            filteredEntries = filteredEntries.Where(e =>
            {
                var entryDate = e.EntryDate.Date;
                bool matchesStart = !startDate.HasValue || entryDate >= startDate.Value.Date;
                bool matchesEnd = !endDate.HasValue || entryDate <= endDate.Value.Date;
                return matchesStart && matchesEnd;
            }).ToList();
        }
        
        if (!string.IsNullOrWhiteSpace(searchTerm))
        {
            filteredEntries = filteredEntries
                .Where(e => (e.Content != null && e.Content.Contains(searchTerm, StringComparison.OrdinalIgnoreCase)) ||
                           (e.Category != null && e.Category.Contains(searchTerm, StringComparison.OrdinalIgnoreCase)) ||
                           (e.Tags != null && e.Tags.Contains(searchTerm, StringComparison.OrdinalIgnoreCase)))
                .ToList();
        }

        if (!string.IsNullOrWhiteSpace(filterMood))
        {
            filteredEntries = filteredEntries
                .Where(e => e.PrimaryMood == filterMood || e.SecondaryMood1 == filterMood || e.SecondaryMood2 == filterMood)
                .ToList();
        }
        
        if (!string.IsNullOrWhiteSpace(filterTag))
        {
            filteredEntries = filteredEntries
                .Where(e => e.Tags != null && e.Tags.Contains(filterTag, StringComparison.OrdinalIgnoreCase))
                .ToList();
        }

        currentPage = 1;
        ApplyPagination();
    }

    private void ApplyPagination()
    {
        totalFilteredCount = filteredEntries.Count;
        totalPages = (int)Math.Ceiling((double)totalFilteredCount / pageSize);
        
        if (currentPage > totalPages && totalPages > 0)
        {
            currentPage = totalPages;
        }
        
        if (totalPages == 0)
        {
            paginatedEntries = new List<JournalEntry>();
        }
        else
        {
            int skip = (currentPage - 1) * pageSize;
            paginatedEntries = filteredEntries
                .Skip(skip)
                .Take(pageSize)
                .ToList();
        }
    }

    private string GetDisplayRange()
    {
        if (totalFilteredCount == 0) return "0";
        int start = (currentPage - 1) * pageSize + 1;
        int end = Math.Min(currentPage * pageSize, totalFilteredCount);
        return $"{start}-{end}";
    }

    private int GetStartPage()
    {
        int maxPagesToShow = 5;
        int half = maxPagesToShow / 2;
        
        if (totalPages <= maxPagesToShow)
            return 1;
        
        if (currentPage <= half)
            return 1;
        
        if (currentPage + half >= totalPages)
            return Math.Max(1, totalPages - maxPagesToShow + 1);
        
        return currentPage - half;
    }

    private int GetEndPage()
    {
        int maxPagesToShow = 5;
        return Math.Min(GetStartPage() + maxPagesToShow - 1, totalPages);
    }

    private void GoToPage(int page)
    {
        if (page >= 1 && page <= totalPages)
        {
            currentPage = page;
            ApplyPagination();
        }
    }

    private void GoToFirstPage()
    {
        GoToPage(1);
    }

    private void GoToPreviousPage()
    {
        if (currentPage > 1)
        {
            GoToPage(currentPage - 1);
        }
    }

    private void GoToNextPage()
    {
        if (currentPage < totalPages)
        {
            GoToPage(currentPage + 1);
        }
    }

    private void GoToLastPage()
    {
        GoToPage(totalPages);
    }

    private void OnPageSizeChanged()
    {
        currentPage = 1;
        ApplyPagination();
        StateHasChanged();
    }

    private void OnFilterChanged()
    {
        ApplyFilters();
        StateHasChanged();
    }
    
    private void ClearDateFilter()
    {
        startDate = null;
        endDate = null;
        ApplyFilters();
        StateHasChanged();
    }

    private void HandleSearch(ChangeEventArgs e)
    {
        searchTerm = e.Value?.ToString() ?? "";
        ApplyFilters();
        StateHasChanged();
    }

    private async Task DeleteEntry(int entryId)
    {
        if (await ConfirmDelete())
        {
            await journalDb.DeleteEntryByIdAsync(entryId);
            await LoadEntries();
        }
    }

    private void EditEntry(int id)
    {
        Nav.NavigateTo($"/new-entry/{id}");
    }

    private Task<bool> ConfirmDelete() => Task.FromResult(true);

    private string GetMoodIcon(string? mood) => (mood ?? string.Empty) switch
    {
        "Happy" => "fa-face-smile",
        "Excited" => "fa-face-grin-stars",
        "Grateful" => "fa-hands-praying",
        "Hopeful" => "fa-sun",
        "Peaceful" => "fa-spa",
        "Energetic" => "fa-bolt",
        "Inspired" => "fa-lightbulb",
        "Loved" => "fa-heart",
        "Calm" => "fa-droplet",
        "Neutral" => "fa-face-meh",
        "Curious" => "fa-magnifying-glass",
        "Focused" => "fa-crosshairs",
        "Determined" => "fa-fist-raised",
        "Patient" => "fa-hourglass-end",
        "Sad" => "fa-face-frown",
        "Angry" => "fa-face-angry",
        "Frustrated" => "fa-face-frustrated",
        "Anxious" => "fa-head-side-virus",
        "Tired" => "fa-battery-quarter",
        "Confused" => "fa-brain",
        "Disappointed" => "fa-thumbs-down",
        "Stressed" => "fa-face-worried",
        _ => "fa-circle"
    };

    private string GetMoodColor(string? mood)
    {
        if (string.IsNullOrEmpty(mood)) return "#007bff";
        var category = MoodCategories.GetMoodCategory(mood);
        return category switch
        {
            "Positive" => "#28a745",
            "Neutral" => "#6c757d",
            "Negative" => "#dc3545",
            _ => "#007bff"
        };
    }

    private string GetMoodClass(string? mood)
    {
        if (string.IsNullOrEmpty(mood)) return "mood-neutral";
        var category = MoodCategories.GetMoodCategory(mood);
        return category switch
        {
            "Positive" => "mood-positive",
            "Neutral" => "mood-neutral",
            "Negative" => "mood-negative",
            _ => "mood-neutral"
        };
    }

}
