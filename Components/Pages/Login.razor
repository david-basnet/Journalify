@page "/"
@page "/login"
@using SQLite
@inject AuthenticationService authService
@inject NavigationManager nav
@inject JournalDatabase journalDb

<PageTitle>Login - Journal App</PageTitle>

<div class="login-container">
    <div class="login-card">
        <div class="login-header">
            <i class="fas fa-book-heart"></i>
            <h2>Journalify</h2>
            <p class="subtitle">Your personal journaling companion</p>
        </div>

        @if (showForgotPassword)
        {
            <!-- Forgot Password Form -->
            <div class="auth-form">
                <h3>Reset Password</h3>
                
                <div class="form-group">
                    <label>Username <span class="required">*</span></label>
                    <input type="text" @bind="forgotPasswordUsername" @bind:event="oninput" class="form-control" placeholder="Enter your username" />
                </div>

                <div class="form-group">
                    <label>New Password <span class="required">*</span></label>
                    <input type="password" @bind="forgotPasswordNewPassword" @bind:event="oninput" class="form-control" placeholder="Enter new password" />
                    <small class="form-hint">At least 6 characters</small>
                </div>

                <div class="form-group">
                    <label>Confirm New Password <span class="required">*</span></label>
                    <input type="password" @bind="forgotPasswordConfirmPassword" @bind:event="oninput" class="form-control" placeholder="Confirm new password" @onkeydown="HandleForgotPasswordKeyDown" />
                </div>

                @if (!string.IsNullOrEmpty(forgotPasswordError))
                {
                    <div class="alert alert-danger">
                        <i class="fas fa-exclamation-circle"></i> @forgotPasswordError
                    </div>
                }

                @if (!string.IsNullOrEmpty(forgotPasswordSuccess))
                {
                    <div class="alert alert-success">
                        <i class="fas fa-check-circle"></i> @forgotPasswordSuccess
                    </div>
                }

                <button @onclick="ResetPassword" class="btn btn-primary full-width" disabled="@isLoading">
                    @if (isLoading)
                    {
                        <i class="fas fa-spinner fa-spin"></i>
                    }
                    else
                    {
                        <i class="fas fa-key"></i>
                    }
                    Reset Password
                </button>

                <div class="auth-switch">
                    <p><a @onclick="() => SwitchToSignIn()" class="link">Back to Sign In</a></p>
                </div>
            </div>
        }
        else if (showSignUp)
        {
            <!-- Sign Up Form -->
            <div class="auth-form">
                <h3>Create Account</h3>
                
                <div class="form-group">
                    <label>Username <span class="required">*</span></label>
                    <input type="text" @bind="signUpUsername" @bind:event="oninput" class="form-control" placeholder="Choose a username" />
                    <small class="form-hint">At least 3 characters</small>
                </div>

                <div class="form-group">
                    <label>Email (Optional)</label>
                    <input type="email" @bind="signUpEmail" @bind:event="oninput" class="form-control" placeholder="your@email.com" />
                </div>

                <div class="form-group">
                    <label>Password <span class="required">*</span></label>
                    <input type="password" @bind="signUpPassword" @bind:event="oninput" class="form-control" placeholder="Create a password" />
                    <small class="form-hint">At least 6 characters</small>
                </div>

                <div class="form-group">
                    <label>Confirm Password <span class="required">*</span></label>
                    <input type="password" @bind="signUpConfirmPassword" @bind:event="oninput" class="form-control" placeholder="Confirm password" @onkeydown="HandleSignUpKeyDown" />
                </div>

                @if (!string.IsNullOrEmpty(signUpError))
                {
                    <div class="alert alert-danger">
                        <i class="fas fa-exclamation-circle"></i> @signUpError
                    </div>
                }

                <button @onclick="SignUp" class="btn btn-primary full-width" disabled="@isLoading">
                    @if (isLoading)
                    {
                        <i class="fas fa-spinner fa-spin"></i>
                    }
                    else
                    {
                        <i class="fas fa-user-plus"></i>
                    }
                    Create Account
                </button>

                <div class="auth-switch">
                    <p>Already have an account? <a @onclick="() => SwitchToSignIn()" class="link">Sign In</a></p>
                </div>
            </div>
        }
        else
        {
            <!-- Sign In Form -->
            <div class="auth-form">
                <h3>Welcome Back</h3>
                
                <div class="form-group">
                    <label>Username</label>
                    <input type="text" @bind="signInUsername" @bind:event="oninput" class="form-control" placeholder="Enter your username" @onkeydown="HandleSignInKeyDown" />
                </div>

                <div class="form-group">
                    <label>Password</label>
                    <input type="password" @bind="signInPassword" @bind:event="oninput" class="form-control" placeholder="Enter your password" @onkeydown="HandleSignInKeyDown" />
                </div>

                @if (!string.IsNullOrEmpty(signInError))
                {
                    <div class="alert alert-danger">
                        <i class="fas fa-exclamation-circle"></i> @signInError
                    </div>
                }

                <button @onclick="SignIn" class="btn btn-primary full-width" disabled="@isLoading">
                    @if (isLoading)
                    {
                        <i class="fas fa-spinner fa-spin"></i>
                    }
                    else
                    {
                        <i class="fas fa-sign-in-alt"></i>
                    }
                    Sign In
                </button>

                <div class="auth-switch">
                    <p>Don't have an account? <a @onclick="() => SwitchToSignUp()" class="link">Sign Up</a></p>
                    <p><a @onclick="() => SwitchToForgotPassword()" class="link forgot-password-link">Forgot Password?</a></p>
                </div>
            </div>
        }
    </div>
</div>

@code {
    private bool showSignUp = false;
    private bool showForgotPassword = false;
    private bool isLoading = false;
    
    private string signInUsername = "";
    private string signInPassword = "";
    private string signInError = "";

    private string signUpUsername = "";
    private string signUpEmail = "";
    private string signUpPassword = "";
    private string signUpConfirmPassword = "";
    private string signUpError = "";

    private string forgotPasswordUsername = "";
    private string forgotPasswordNewPassword = "";
    private string forgotPasswordConfirmPassword = "";
    private string forgotPasswordError = "";
    private string forgotPasswordSuccess = "";

    protected override async Task OnInitializedAsync()
    {
        try
        {
            var restored = await authService.RestoreSessionAsync();
            if (restored && authService.IsAuthenticated)
            {
                await Task.Delay(100);
                nav.NavigateTo("/dashboard", forceLoad: true);
            }
        }
        catch (Exception ex)
        {
            System.Diagnostics.Debug.WriteLine($"Error in Login OnInitializedAsync: {ex}");
        }
    }

    private void SwitchToSignUp()
    {
        showSignUp = true;
        showForgotPassword = false;
        signInError = "";
        signUpError = "";
        forgotPasswordError = "";
        forgotPasswordSuccess = "";
    }

    private void SwitchToSignIn()
    {
        showSignUp = false;
        showForgotPassword = false;
        signInError = "";
        signUpError = "";
        forgotPasswordError = "";
        forgotPasswordSuccess = "";
    }

    private void SwitchToForgotPassword()
    {
        showSignUp = false;
        showForgotPassword = true;
        signInError = "";
        signUpError = "";
        forgotPasswordError = "";
        forgotPasswordSuccess = "";
    }

    private async Task SignIn()
    {
        signInError = "";
        isLoading = true;

        if (string.IsNullOrWhiteSpace(signInUsername) || string.IsNullOrWhiteSpace(signInPassword))
        {
            signInError = "Please enter both username and password.";
            isLoading = false;
            return;
        }

        try
        {
            var result = await authService.SignInAsync(signInUsername.Trim(), signInPassword);
            if (result.Success)
            {
                nav.NavigateTo("/dashboard");
            }
            else
            {
                signInError = result.Message;
            }
        }
        catch (SQLiteException ex)
        {
            signInError = "Database error occurred. Please try again.";
            System.Diagnostics.Debug.WriteLine($"SQLite Error: {ex.Message}");
        }
        catch (Exception ex)
        {
            signInError = $"An error occurred: {ex.Message}";
            System.Diagnostics.Debug.WriteLine($"SignIn Error: {ex}");
        }
        finally
        {
            isLoading = false;
        }
    }

    private async Task SignUp()
    {
        signUpError = "";
        isLoading = true;

        if (string.IsNullOrWhiteSpace(signUpUsername))
        {
            signUpError = "Username is required.";
            isLoading = false;
            return;
        }

        if (signUpUsername.Length < 3)
        {
            signUpError = "Username must be at least 3 characters long.";
            isLoading = false;
            return;
        }

        if (string.IsNullOrWhiteSpace(signUpPassword))
        {
            signUpError = "Password is required.";
            isLoading = false;
            return;
        }

        if (signUpPassword.Length < 6)
        {
            signUpError = "Password must be at least 6 characters long.";
            isLoading = false;
            return;
        }

        if (signUpPassword != signUpConfirmPassword)
        {
            signUpError = "Passwords do not match.";
            isLoading = false;
            return;
        }

        try
        {
            await authService.SignUpAsync(
                signUpUsername.Trim(), 
                signUpPassword, 
                string.IsNullOrWhiteSpace(signUpEmail) ? null : signUpEmail.Trim()
            );

            var result = await authService.SignInAsync(signUpUsername.Trim(), signUpPassword);
            if (result.Success)
            {
                nav.NavigateTo("/dashboard");
            }
            else
            {
                signUpError = "Account created but failed to sign in. Please try signing in manually.";
            }
        }
        catch (ArgumentException ex)
        {
            signUpError = ex.Message;
        }
        catch (InvalidOperationException ex)
        {
            signUpError = ex.Message;
        }
        catch (SQLiteException ex)
        {
            signUpError = "Database error occurred. Please try again.";
            System.Diagnostics.Debug.WriteLine($"SQLite Error: {ex.Message}");
        }
        catch (Exception ex)
        {
            signUpError = $"An unexpected error occurred: {ex.Message}";
            System.Diagnostics.Debug.WriteLine($"SignUp Error: {ex}");
        }
        finally
        {
            isLoading = false;
        }
    }

    private async void HandleSignInKeyDown(KeyboardEventArgs e)
    {
        if (e.Key == "Enter" && !isLoading)
        {
            await SignIn();
        }
    }

    private async void HandleSignUpKeyDown(KeyboardEventArgs e)
    {
        if (e.Key == "Enter" && !isLoading)
        {
            await SignUp();
        }
    }

    private async Task ResetPassword()
    {
        forgotPasswordError = "";
        forgotPasswordSuccess = "";
        isLoading = true;

        if (string.IsNullOrWhiteSpace(forgotPasswordUsername))
        {
            forgotPasswordError = "Username is required.";
            isLoading = false;
            return;
        }

        if (string.IsNullOrWhiteSpace(forgotPasswordNewPassword))
        {
            forgotPasswordError = "New password is required.";
            isLoading = false;
            return;
        }

        if (forgotPasswordNewPassword.Length < 6)
        {
            forgotPasswordError = "Password must be at least 6 characters long.";
            isLoading = false;
            return;
        }

        if (forgotPasswordNewPassword != forgotPasswordConfirmPassword)
        {
            forgotPasswordError = "Passwords do not match.";
            isLoading = false;
            return;
        }

        try
        {
            await authService.ResetPasswordAsync(forgotPasswordUsername.Trim(), forgotPasswordNewPassword);
            forgotPasswordSuccess = "Password reset successfully! You can now sign in with your new password.";
            forgotPasswordUsername = "";
            forgotPasswordNewPassword = "";
            forgotPasswordConfirmPassword = "";
            
            await Task.Delay(2000);
            SwitchToSignIn();
        }
        catch (ArgumentException ex)
        {
            forgotPasswordError = ex.Message;
        }
        catch (InvalidOperationException ex)
        {
            forgotPasswordError = ex.Message;
        }
        catch (Exception ex)
        {
            forgotPasswordError = $"An error occurred: {ex.Message}";
            System.Diagnostics.Debug.WriteLine($"ResetPassword Error: {ex}");
        }
        finally
        {
            isLoading = false;
        }
    }

    private async void HandleForgotPasswordKeyDown(KeyboardEventArgs e)
    {
        if (e.Key == "Enter" && !isLoading)
        {
            await ResetPassword();
        }
    }
}

